{% extends "base.html" %}

{% block title %}Playground - {{ config.title }}{% endblock title %}

{% block head %}
<style>
.playground-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    height: calc(100vh - 200px);
    min-height: 500px;
    padding: 0 1rem 1rem;
}

.editor-pane, .output-pane {
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color, #2a2a2a);
    border-radius: 8px;
    overflow: hidden;
    background: #1e1e1e;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.pane-header {
    padding: 0.75rem 1rem;
    background: linear-gradient(180deg, #2a2a2a 0%, #242424 100%);
    border-bottom: 1px solid #333;
    font-weight: 600;
    font-size: 0.8rem;
    color: #999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.pane-header span:first-child {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pane-header span:first-child::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4ade80;
}

.output-pane .pane-header span:first-child::before {
    background: #60a5fa;
}

.pane-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

#editor, #output {
    height: 100%;
}

.diagnostics {
    padding: 0.6rem 1rem;
    background: linear-gradient(180deg, #3d1515 0%, #2d1010 100%);
    border-top: 1px solid #5c2020;
    font-size: 0.85rem;
    font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    color: #f87171;
    max-height: 150px;
    overflow-y: auto;
}

.diagnostics:empty {
    display: none;
}

.diagnostics.success {
    background: linear-gradient(180deg, #14352a 0%, #0d261e 100%);
    border-color: #166534;
    color: #4ade80;
}

.diagnostic-item {
    margin: 0.25rem 0;
}

.diagnostic-location {
    color: #888;
    margin-right: 0.5rem;
    font-size: 0.8rem;
}

/* CodeMirror theme overrides */
.cm-editor {
    height: 100%;
    font-size: 14px;
    background: #1e1e1e;
}

.cm-scroller {
    overflow: auto;
}

.cm-content {
    font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
}

.cm-gutters {
    background: #1e1e1e;
    border-right: 1px solid #333;
}

.cm-activeLineGutter {
    background: #2a2a2a;
}

.cm-activeLine {
    background: rgba(255, 255, 255, 0.03);
}

/* Loading state */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    font-style: italic;
}

@media (max-width: 900px) {
    .playground-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 150px);
    }
}
</style>
{% endblock head %}

{% block content %}
<h1>{{ page.title }}</h1>

<div class="playground-container">
    <div class="editor-pane">
        <div class="pane-header">
            <span>Styx</span>
            <label style="display: flex; align-items: center; gap: 0.4rem; font-weight: normal; text-transform: none; letter-spacing: normal;">
                <input type="checkbox" id="vim-mode" checked>
                vim
            </label>
            <span id="status">Loading...</span>
        </div>
        <div class="pane-content">
            <div id="editor"><div class="loading">Loading editor...</div></div>
        </div>
        <div id="diagnostics" class="diagnostics"></div>
    </div>

    <div class="output-pane">
        <div class="pane-header">
            <span>JSON</span>
        </div>
        <div class="pane-content">
            <div id="output"><div class="loading">Loading...</div></div>
        </div>
    </div>
</div>

<script>
// Set WASM URL before module loads (will be rewritten to cache-busted path)
window.STYX_WASM_URL = '/wasm/styx_wasm_bg.wasm';
</script>
<script type="module">
// Import from Vite-bundled playground (all deps properly deduped)
import { EditorView, EditorState, Compartment, basicSetup, oneDark, json, vim, styx } from '/playground/playground.js';

// Import Styx WASM
import init, { to_json, from_json, parse, version } from '/wasm/styx_wasm.js';

const DEFAULT_SOURCE = `// Welcome to the Styx Playground!
// Edit this document and see the JSON output on the right.

/// Server configuration
server {
    host localhost
    port 8080

    // Tags add semantic meaning to values
    timeout @duration(30s)

    tls {
        enabled true
        cert /etc/ssl/cert.pem
        key /etc/ssl/key.pem
    }
}

/// Database settings
database {
    url postgres://localhost/myapp
    pool_size 10
    max_connections @int(100)
}

/// Feature flags (a sequence)
features (
    dark-mode
    notifications
    @experimental(analytics)
)

/// Multi-line content with heredocs
query <<SQL
SELECT id, name, email
FROM users
WHERE active = true
SQL
`;

let styxEditor;
let jsonEditor;
let styxDebounceTimer;
let jsonDebounceTimer;
let vimCompartment;
let updatingFromStyx = false;
let updatingFromJson = false;

async function main() {
    // Initialize WASM
    await init(window.STYX_WASM_URL);

    document.getElementById('status').textContent = `v${version()}`;

    // JSON editor update listener - convert JSON to Styx
    const jsonUpdateListener = EditorView.updateListener.of((update) => {
        if (update.docChanged && !updatingFromStyx) {
            clearTimeout(jsonDebounceTimer);
            jsonDebounceTimer = setTimeout(() => {
                updateStyxFromJson(update.state.doc.toString());
            }, 300);
        }
    });

    // Create JSON editor (editable - bidirectional sync)
    jsonEditor = new EditorView({
        state: EditorState.create({
            doc: '',
            extensions: [
                basicSetup,
                oneDark,
                json(),
                jsonUpdateListener,
            ],
        }),
        parent: document.getElementById('output'),
    });

    // Styx editor update listener - convert Styx to JSON
    const styxUpdateListener = EditorView.updateListener.of((update) => {
        if (update.docChanged && !updatingFromJson) {
            clearTimeout(styxDebounceTimer);
            styxDebounceTimer = setTimeout(() => {
                updateJsonFromStyx(update.state.doc.toString());
            }, 150);
        }
    });

    // Vim mode compartment for dynamic toggling
    vimCompartment = new Compartment();
    const vimCheckbox = document.getElementById('vim-mode');

    // Load vim setting from localStorage (default: true)
    const storedVim = localStorage.getItem('styx-playground-vim');
    const vimEnabled = storedVim === null ? true : storedVim === 'true';
    vimCheckbox.checked = vimEnabled;

    styxEditor = new EditorView({
        state: EditorState.create({
            doc: DEFAULT_SOURCE,
            extensions: [
                basicSetup,
                oneDark,
                styx(),
                styxUpdateListener,
                vimCompartment.of(vimEnabled ? vim() : []),
            ],
        }),
        parent: document.getElementById('editor'),
    });

    // Handle vim mode toggle
    vimCheckbox.addEventListener('change', (e) => {
        const enabled = e.target.checked;
        localStorage.setItem('styx-playground-vim', enabled);
        styxEditor.dispatch({
            effects: vimCompartment.reconfigure(enabled ? vim() : [])
        });
    });

    // Clear loading states
    document.getElementById('editor').querySelector('.loading')?.remove();
    document.getElementById('output').querySelector('.loading')?.remove();

    // Initial render
    updateJsonFromStyx(DEFAULT_SOURCE);
}

// Update JSON editor from Styx source
function updateJsonFromStyx(source) {
    const diagnosticsEl = document.getElementById('diagnostics');

    // Parse and get diagnostics
    const parseResult = parse(source);

    // Convert to JSON
    const jsonResult = to_json(source);

    // Update diagnostics
    if (parseResult.diagnostics && parseResult.diagnostics.length > 0) {
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = parseResult.diagnostics.map(d => {
            const loc = `${d.start}-${d.end}`;
            return `<div class="diagnostic-item"><span class="diagnostic-location">[${loc}]</span>${escapeHtml(d.message)}</div>`;
        }).join('');
    } else {
        // No errors - hide the diagnostics panel
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = '';
    }

    // Update JSON editor content
    if (jsonResult.success) {
        updatingFromStyx = true;
        jsonEditor.dispatch({
            changes: {
                from: 0,
                to: jsonEditor.state.doc.length,
                insert: jsonResult.jsonString
            }
        });
        updatingFromStyx = false;
    } else {
        updatingFromStyx = true;
        jsonEditor.dispatch({
            changes: {
                from: 0,
                to: jsonEditor.state.doc.length,
                insert: `// Error: ${jsonResult.error || 'Unknown error'}`
            }
        });
        updatingFromStyx = false;
    }
}

// Update Styx editor from JSON source
function updateStyxFromJson(jsonSource) {
    // Try to parse and convert JSON to Styx
    const result = from_json(jsonSource);

    if (result.success) {
        updatingFromJson = true;
        styxEditor.dispatch({
            changes: {
                from: 0,
                to: styxEditor.state.doc.length,
                insert: result.styxString
            }
        });
        updatingFromJson = false;

        // Clear diagnostics since JSON was valid
        const diagnosticsEl = document.getElementById('diagnostics');
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = '';
    }
    // If JSON is invalid, don't update Styx - just let user fix the JSON
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

main().catch(err => {
    console.error('Failed to initialize playground:', err);
    document.getElementById('status').textContent = 'Error';
});
</script>
{% endblock content %}

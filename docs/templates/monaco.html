{% extends "base.html" %}

{% block title %}Monaco Playground - {{ config.title }}{% endblock title %}

{% block head %}
<style>
.playground-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    height: calc(100vh - 200px);
    min-height: 500px;
    padding: 0 1rem 1rem;
}

.editor-pane, .output-pane {
    display: flex;
    flex-direction: column;
    border: 1px solid #45475a;
    border-radius: 8px;
    overflow: hidden;
    background: #1e1e2e;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
}

.pane-header {
    padding: 0.75rem 1rem;
    background: linear-gradient(180deg, #181825 0%, #11111b 100%);
    border-bottom: 1px solid #45475a;
    font-weight: 600;
    font-size: 0.8rem;
    color: #999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.pane-header span:first-child {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pane-header span:first-child::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #a6e3a1;
}

.output-pane .pane-header span:first-child::before {
    background: #89b4fa;
}

.pane-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

#editor, #output {
    height: 100%;
}

.diagnostics {
    padding: 0.6rem 1rem;
    background: linear-gradient(180deg, #302030 0%, #1e1825 100%);
    border-top: 1px solid #45475a;
    font-size: 0.85rem;
    font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    color: #f38ba8;
    max-height: 150px;
    overflow-y: auto;
}

.diagnostics:empty {
    display: none;
}

.diagnostic-item {
    margin: 0.25rem 0;
}

.diagnostic-location {
    color: #888;
    margin-right: 0.5rem;
    font-size: 0.8rem;
}

#vim-status {
    padding: 0.3rem 1rem;
    background: #181825;
    border-top: 1px solid #45475a;
    font-family: monospace;
    font-size: 0.75rem;
    color: #cdd6f4;
    min-height: 1.2em;
}

.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    font-style: italic;
}

@media (max-width: 900px) {
    .playground-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 150px);
    }
}

.playground-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    color: #888;
}

.playground-nav a {
    color: #89b4fa;
    text-decoration: none;
}

.playground-nav a:hover {
    text-decoration: underline;
}

.playground-nav .separator {
    color: #45475a;
}

.playground-nav .current {
    color: #cdd6f4;
}

.playground-nav .switch {
    margin-left: auto;
}

.playground-nav .switch a {
    color: #a6e3a1;
}
</style>
{% endblock head %}

{% block content %}
<nav class="playground-nav">
    <a href="/tools">‚Üê Tools</a>
    <span class="separator">/</span>
    <a href="/tools/playgrounds">Playgrounds</a>
    <span class="separator">/</span>
    <span class="current">Monaco</span>
    <span class="switch">
        <a href="/tools/playgrounds/codemirror">Switch to CodeMirror</a>
    </span>
</nav>
<h1>{{ page.title }}</h1>

<div class="playground-container">
    <div class="editor-pane">
        <div class="pane-header">
            <span>Styx</span>
            <label style="display: flex; align-items: center; gap: 0.4rem; font-weight: normal; text-transform: none; letter-spacing: normal;">
                <input type="checkbox" id="vim-mode" checked>
                vim
            </label>
            <span id="status">Loading...</span>
        </div>
        <div class="pane-content">
            <div id="editor"><div class="loading">Loading Monaco editor...</div></div>
        </div>
        <div id="diagnostics" class="diagnostics"></div>
        <div id="vim-status"></div>
    </div>

    <div class="output-pane">
        <div class="pane-header">
            <span>JSON</span>
        </div>
        <div class="pane-content">
            <div id="output"><div class="loading">Loading...</div></div>
        </div>
    </div>
</div>

<script type="module">
// Load from esm.sh CDN - no bundling required
import * as monaco from 'https://esm.sh/monaco-editor@0.52.0';
import { initVimMode } from 'https://esm.sh/monaco-vim@0.4.1?deps=monaco-editor@0.52.0';
import { registerStyxLanguage } from 'https://esm.sh/@bearcove/monaco-lang-styx@0.1.0?deps=monaco-editor@0.52.0';

// Import embedded language definitions for heredoc injection
import * as sqlLang from 'https://esm.sh/monaco-editor@0.52.0/esm/vs/basic-languages/sql/sql';
import * as javascriptLang from 'https://esm.sh/monaco-editor@0.52.0/esm/vs/basic-languages/javascript/javascript';
import * as yamlLang from 'https://esm.sh/monaco-editor@0.52.0/esm/vs/basic-languages/yaml/yaml';
import * as shellLang from 'https://esm.sh/monaco-editor@0.52.0/esm/vs/basic-languages/shell/shell';

// Import Styx WASM from esm.sh
import init, { to_json, from_json, parse, version } from 'https://esm.sh/@bearcove/styx-wasm@0.1.0';

const DEFAULT_SOURCE = `// Welcome to the Styx Monaco Playground!
// Edit this document and see the JSON output on the right.

/// Server configuration
server {
    host localhost
    port 8080

    // Tags add semantic meaning to values
    timeout @duration(30s)

    tls {
        enabled true
        cert /etc/ssl/cert.pem
        key /etc/ssl/key.pem
    }
}

/// Database settings
database {
    url postgres://localhost/myapp
    pool_size 10
    max_connections @int(100)
}

/// Feature flags (a sequence)
features (
    dark-mode
    notifications
    @experimental(analytics)
)

/// Multi-line content with heredocs (language hint after comma)
query <<SQL,sql
SELECT id, name, email
FROM users
WHERE active = true
SQL
`;

let styxEditor;
let jsonEditor;
let styxDebounceTimer;
let jsonDebounceTimer;
let updatingFromStyx = false;
let updatingFromJson = false;
let vimModeStyxEditor = null;
let vimModeJsonEditor = null;

async function main() {
    // Initialize WASM
    await init();

    document.getElementById('status').textContent = `v${version()}`;

    // Register embedded languages for heredoc injection
    const embeddedLanguages = [
        { id: 'sql', def: sqlLang },
        { id: 'javascript', def: javascriptLang },
        { id: 'yaml', def: yamlLang },
        { id: 'shell', def: shellLang },
    ];

    // Register Styx language with embedded languages
    registerStyxLanguage(monaco, embeddedLanguages);

    // Clear loading states
    document.getElementById('editor').innerHTML = '';
    document.getElementById('output').innerHTML = '';

    // Create Styx editor
    styxEditor = monaco.editor.create(document.getElementById('editor'), {
        value: DEFAULT_SOURCE,
        language: 'styx',
        theme: 'catppuccin-mocha',
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        renderLineHighlight: 'all',
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        fontFamily: "'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace",
    });

    // Create JSON editor
    jsonEditor = monaco.editor.create(document.getElementById('output'), {
        value: '',
        language: 'json',
        theme: 'catppuccin-mocha',
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        renderLineHighlight: 'all',
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        fontFamily: "'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace",
    });

    // Vim mode setup
    const vimCheckbox = document.getElementById('vim-mode');
    const vimStatusBar = document.getElementById('vim-status');
    const storedVim = localStorage.getItem('styx-monaco-vim');
    const vimEnabled = storedVim === null ? true : storedVim === 'true';
    vimCheckbox.checked = vimEnabled;

    function enableVim() {
        if (!vimModeStyxEditor) {
            vimModeStyxEditor = initVimMode(styxEditor, vimStatusBar);
        }
        if (!vimModeJsonEditor) {
            vimModeJsonEditor = initVimMode(jsonEditor, vimStatusBar);
        }
        vimStatusBar.style.display = 'block';
    }

    function disableVim() {
        if (vimModeStyxEditor) {
            vimModeStyxEditor.dispose();
            vimModeStyxEditor = null;
        }
        if (vimModeJsonEditor) {
            vimModeJsonEditor.dispose();
            vimModeJsonEditor = null;
        }
        vimStatusBar.textContent = '';
        vimStatusBar.style.display = 'none';
    }

    if (vimEnabled) {
        enableVim();
    } else {
        vimStatusBar.style.display = 'none';
    }

    vimCheckbox.addEventListener('change', (e) => {
        const enabled = e.target.checked;
        localStorage.setItem('styx-monaco-vim', enabled);
        if (enabled) {
            enableVim();
        } else {
            disableVim();
        }
    });

    // Styx -> JSON conversion on change
    styxEditor.onDidChangeModelContent(() => {
        if (!updatingFromJson) {
            clearTimeout(styxDebounceTimer);
            styxDebounceTimer = setTimeout(() => {
                updateJsonFromStyx(styxEditor.getValue());
            }, 150);
        }
    });

    // JSON -> Styx conversion on change
    jsonEditor.onDidChangeModelContent(() => {
        if (!updatingFromStyx) {
            clearTimeout(jsonDebounceTimer);
            jsonDebounceTimer = setTimeout(() => {
                updateStyxFromJson(jsonEditor.getValue());
            }, 300);
        }
    });

    // Initial render
    updateJsonFromStyx(DEFAULT_SOURCE);
}

function updateJsonFromStyx(source) {
    const diagnosticsEl = document.getElementById('diagnostics');
    const parseResult = parse(source);
    const jsonResult = to_json(source);

    if (parseResult.diagnostics && parseResult.diagnostics.length > 0) {
        diagnosticsEl.innerHTML = parseResult.diagnostics.map(d => {
            const loc = `${d.start}-${d.end}`;
            return `<div class="diagnostic-item"><span class="diagnostic-location">[${loc}]</span>${escapeHtml(d.message)}</div>`;
        }).join('');
    } else {
        diagnosticsEl.innerHTML = '';
    }

    if (jsonResult.success) {
        updatingFromStyx = true;
        jsonEditor.setValue(jsonResult.jsonString);
        updatingFromStyx = false;
    } else {
        updatingFromStyx = true;
        jsonEditor.setValue(`// Error: ${jsonResult.error || 'Unknown error'}`);
        updatingFromStyx = false;
    }
}

function updateStyxFromJson(jsonSource) {
    const result = from_json(jsonSource);
    if (result.success) {
        updatingFromJson = true;
        styxEditor.setValue(result.styxString);
        updatingFromJson = false;
        document.getElementById('diagnostics').innerHTML = '';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

main().catch(err => {
    console.error('Failed to initialize Monaco playground:', err);
    document.getElementById('status').textContent = 'Error';
});
</script>
{% endblock content %}

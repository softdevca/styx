{% extends "base.html" %}

{% block title %}Monaco Playground - {{ config.title }}{% endblock title %}

{% block head %}
<style>
.playground-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    height: calc(100vh - 200px);
    min-height: 500px;
    padding: 0 1rem 1rem;
}

.editor-pane, .output-pane {
    display: flex;
    flex-direction: column;
    border: 1px solid #3e4451;
    border-radius: 8px;
    overflow: hidden;
    background: #282c34;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.pane-header {
    padding: 0.75rem 1rem;
    background: linear-gradient(180deg, #21252b 0%, #1e2227 100%);
    border-bottom: 1px solid #3e4451;
    font-weight: 600;
    font-size: 0.8rem;
    color: #999;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.pane-header span:first-child {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pane-header span:first-child::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #4ade80;
}

.output-pane .pane-header span:first-child::before {
    background: #60a5fa;
}

.pane-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

#editor, #output {
    height: 100%;
}

.diagnostics {
    padding: 0.6rem 1rem;
    background: linear-gradient(180deg, #3b2020 0%, #2d1818 100%);
    border-top: 1px solid #5c3030;
    font-size: 0.85rem;
    font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
    color: #e06c75;
    max-height: 150px;
    overflow-y: auto;
}

.diagnostics:empty {
    display: none;
}

.diagnostics.success {
    background: linear-gradient(180deg, #1e3a2f 0%, #162b23 100%);
    border-color: #2d5a45;
    color: #98c379;
}

.diagnostic-item {
    margin: 0.25rem 0;
}

.diagnostic-location {
    color: #888;
    margin-right: 0.5rem;
    font-size: 0.8rem;
}

/* Loading state */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
    font-style: italic;
}

@media (max-width: 900px) {
    .playground-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr 1fr;
        height: calc(100vh - 150px);
    }
}
</style>
{% endblock head %}

{% block content %}
<h1>{{ page.title }}</h1>

<div class="playground-container">
    <div class="editor-pane">
        <div class="pane-header">
            <span>Styx</span>
            <label style="display: flex; align-items: center; gap: 0.4rem; font-weight: normal; text-transform: none; letter-spacing: normal;">
                <input type="checkbox" id="vim-mode" checked>
                vim
            </label>
            <span id="status">Loading...</span>
        </div>
        <div class="pane-content">
            <div id="editor"><div class="loading">Loading Monaco editor...</div></div>
        </div>
        <div id="diagnostics" class="diagnostics"></div>
    </div>

    <div class="output-pane">
        <div class="pane-header">
            <span>JSON</span>
        </div>
        <div class="pane-content">
            <div id="output"><div class="loading">Loading...</div></div>
        </div>
    </div>
</div>

<script>
// Set WASM URL before module loads (will be rewritten to cache-busted path)
window.STYX_WASM_URL = '/wasm/styx_wasm_bg.wasm';
</script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-vim@0.4.1/dist/monaco-vim.min.js"></script>
<script type="module">
// Import Styx WASM
import init, { to_json, from_json, parse, version } from '/wasm/styx_wasm.js';

// Wait for Monaco to load
const monacoPromise = new Promise((resolve) => {
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs' } });
    require(['vs/editor/editor.main'], resolve);
});

// Styx Monarch grammar definition
const styxLanguage = {
    defaultToken: 'invalid',
    tokenPostfix: '.styx',

    brackets: [
        { open: '{', close: '}', token: 'delimiter.curly' },
        { open: '(', close: ')', token: 'delimiter.parenthesis' },
    ],

    tokenizer: {
        // Start in key position (beginning of line/entry)
        root: [
            [/[ \t]+/, 'white'],
            [/\r?\n/, 'white'],
            [/\/\/\/.*$/, 'comment.doc'],
            [/\/\/.*$/, 'comment'],
            // After seeing a key, switch to value mode
            [/@[A-Za-z_][A-Za-z0-9_\-]*/, { token: 'tag', next: '@value' }],
            [/@(?![A-Za-z_])/, { token: 'tag', next: '@value' }],
            [/r(#*)"/, { token: 'string.key.begin', next: '@rawStringKey.$1' }],
            [/"/, { token: 'string.key.begin', next: '@stringKey' }],
            [/[{}]/, '@brackets'],
            [/\(/, { token: 'delimiter.parenthesis', next: '@sequence' }],
            [/,/, 'delimiter.comma'],
            [/[^\s{}\(\),"=@<>\r\n]+/, { token: 'key', next: '@value' }],
        ],

        // Value position (after key)
        value: [
            [/[ \t]+/, 'white'],
            [/\r?\n/, { token: 'white', next: '@pop' }],
            [/\/\/.*$/, { token: 'comment', next: '@pop' }],
            [/@[A-Za-z_][A-Za-z0-9_\-]*/, 'tag'],
            [/@(?![A-Za-z_])/, 'tag'],
            [/r(#*)"/, { token: 'string.begin', next: '@rawString.$1' }],
            [/<<([A-Z][A-Z0-9_]*)(,[a-z]+)?/, { token: 'string.heredoc.begin', next: '@heredoc.$1' }],
            [/"/, { token: 'string.begin', next: '@string' }],
            [/\{/, { token: 'delimiter.curly', next: '@root' }],
            [/\}/, { token: 'delimiter.curly', next: '@pop' }],
            [/\(/, { token: 'delimiter.parenthesis', next: '@sequence' }],
            [/,/, { token: 'delimiter.comma', next: '@pop' }],
            [/[^\s{}\(\),"=@>\r\n]+>[^\s{}\(\),"\r\n]+/, 'attribute'],
            [/[^\s{}\(\),"=@<>\r\n]+/, 'value'],
        ],

        // Inside a sequence - all items are values
        sequence: [
            [/[ \t\r\n]+/, 'white'],
            [/\/\/\/.*$/, 'comment.doc'],
            [/\/\/.*$/, 'comment'],
            [/@[A-Za-z_][A-Za-z0-9_\-]*/, 'tag'],
            [/@(?![A-Za-z_])/, 'tag'],
            [/r(#*)"/, { token: 'string.begin', next: '@rawString.$1' }],
            [/"/, { token: 'string.begin', next: '@string' }],
            [/\{/, { token: 'delimiter.curly', next: '@root' }],
            [/\(/, { token: 'delimiter.parenthesis', next: '@sequence' }],
            [/\)/, { token: 'delimiter.parenthesis', next: '@pop' }],
            [/[^\s{}\(\),"=@<>\r\n]+/, 'value'],
        ],

        // String in key position
        stringKey: [
            [/[^\\"]+/, 'string.key'],
            [/\\./, 'string.escape'],
            [/"/, { token: 'string.key.end', next: '@value' }],
        ],

        rawStringKey: [
            [/"(#*)/, {
                cases: {
                    '"$S2': { token: 'string.key.end', next: '@value' },
                    '@default': 'string.key',
                },
            }],
            [/[^"]+/, 'string.key'],
        ],

        string: [
            [/[^\\"]+/, 'string'],
            [/\\./, 'string.escape'],
            [/"/, { token: 'string.end', next: '@pop' }],
        ],

        rawString: [
            [/"(#*)/, {
                cases: {
                    '"$S2': { token: 'string.raw.end', next: '@pop' },
                    '@default': 'string.raw',
                },
            }],
            [/[^"]+/, 'string.raw'],
        ],

        heredoc: [
            [/^([A-Z][A-Z0-9_]*)$/, {
                cases: {
                    '$1==$S2': { token: 'string.heredoc.end', next: '@pop' },
                    '@default': 'string.heredoc',
                },
            }],
            [/.*$/, 'string.heredoc'],
        ],
    },
};

// Styx language configuration
const styxLanguageConfig = {
    comments: { lineComment: '//' },
    brackets: [['{', '}'], ['(', ')']],
    autoClosingPairs: [
        { open: '{', close: '}' },
        { open: '(', close: ')' },
        { open: '"', close: '"' },
    ],
    surroundingPairs: [
        { open: '{', close: '}' },
        { open: '(', close: ')' },
        { open: '"', close: '"' },
    ],
};

// OneDark-inspired theme for Styx
const styxDarkTheme = {
    base: 'vs-dark',
    inherit: true,
    rules: [
        { token: 'comment', foreground: '5c6370', fontStyle: 'italic' },
        { token: 'comment.doc', foreground: '7f848e', fontStyle: 'italic' },
        { token: 'tag', foreground: 'c678dd' },
        { token: 'key', foreground: 'e06c75' },
        { token: 'value', foreground: '61afef' },
        { token: 'string', foreground: '98c379' },
        { token: 'string.key', foreground: 'e06c75' },
        { token: 'string.raw', foreground: '98c379' },
        { token: 'string.heredoc', foreground: '98c379' },
        { token: 'string.escape', foreground: 'd19a66' },
        { token: 'attribute', foreground: '56b6c2' },
        { token: 'delimiter.curly', foreground: 'e5c07b' },
        { token: 'delimiter.parenthesis', foreground: 'c678dd' },
        { token: 'delimiter.comma', foreground: 'abb2bf' },
    ],
    colors: {
        'editor.background': '#282c34',
        'editor.foreground': '#abb2bf',
        'editor.lineHighlightBackground': '#2c313c',
        'editorCursor.foreground': '#528bff',
        'editor.selectionBackground': '#3e4451',
        'editorLineNumber.foreground': '#4b5263',
        'editorLineNumber.activeForeground': '#abb2bf',
    },
};

const DEFAULT_SOURCE = `// Welcome to the Styx Monaco Playground!
// Edit this document and see the JSON output on the right.

/// Server configuration
server {
    host localhost
    port 8080

    // Tags add semantic meaning to values
    timeout @duration(30s)

    tls {
        enabled true
        cert /etc/ssl/cert.pem
        key /etc/ssl/key.pem
    }
}

/// Database settings
database {
    url postgres://localhost/myapp
    pool_size 10
    max_connections @int(100)
}

/// Feature flags (a sequence)
features (
    dark-mode
    notifications
    @experimental(analytics)
)

/// Multi-line content with heredocs
query <<SQL
SELECT id, name, email
FROM users
WHERE active = true
SQL
`;

let styxEditor;
let jsonEditor;
let styxDebounceTimer;
let jsonDebounceTimer;
let updatingFromStyx = false;
let updatingFromJson = false;
let vimMode = null;

async function main() {
    // Initialize WASM and Monaco in parallel
    const [_, monacoModule] = await Promise.all([
        init(window.STYX_WASM_URL),
        monacoPromise
    ]);

    document.getElementById('status').textContent = `v${version()}`;

    // Register Styx language with Monaco
    monaco.languages.register({ id: 'styx' });
    monaco.languages.setMonarchTokensProvider('styx', styxLanguage);
    monaco.languages.setLanguageConfiguration('styx', styxLanguageConfig);
    monaco.editor.defineTheme('styx-dark', styxDarkTheme);

    // Clear loading states
    document.getElementById('editor').innerHTML = '';
    document.getElementById('output').innerHTML = '';

    // Create Styx editor
    styxEditor = monaco.editor.create(document.getElementById('editor'), {
        value: DEFAULT_SOURCE,
        language: 'styx',
        theme: 'styx-dark',
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        renderLineHighlight: 'all',
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        fontFamily: "'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace",
    });

    // Create JSON editor
    jsonEditor = monaco.editor.create(document.getElementById('output'), {
        value: '',
        language: 'json',
        theme: 'styx-dark',
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        lineNumbers: 'on',
        renderLineHighlight: 'all',
        scrollBeyondLastLine: false,
        wordWrap: 'on',
        fontFamily: "'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace",
    });

    // Vim mode setup
    const vimCheckbox = document.getElementById('vim-mode');
    const storedVim = localStorage.getItem('styx-monaco-vim');
    const vimEnabled = storedVim === null ? true : storedVim === 'true';
    vimCheckbox.checked = vimEnabled;

    function enableVim() {
        if (!vimMode && window.MonacoVim) {
            vimMode = window.MonacoVim.initVimMode(styxEditor);
        }
    }

    function disableVim() {
        if (vimMode) {
            vimMode.dispose();
            vimMode = null;
        }
    }

    if (vimEnabled) {
        enableVim();
    }

    vimCheckbox.addEventListener('change', (e) => {
        const enabled = e.target.checked;
        localStorage.setItem('styx-monaco-vim', enabled);
        if (enabled) {
            enableVim();
        } else {
            disableVim();
        }
    });

    // Styx -> JSON conversion on change
    styxEditor.onDidChangeModelContent(() => {
        if (!updatingFromJson) {
            clearTimeout(styxDebounceTimer);
            styxDebounceTimer = setTimeout(() => {
                updateJsonFromStyx(styxEditor.getValue());
            }, 150);
        }
    });

    // JSON -> Styx conversion on change
    jsonEditor.onDidChangeModelContent(() => {
        if (!updatingFromStyx) {
            clearTimeout(jsonDebounceTimer);
            jsonDebounceTimer = setTimeout(() => {
                updateStyxFromJson(jsonEditor.getValue());
            }, 300);
        }
    });

    // Initial render
    updateJsonFromStyx(DEFAULT_SOURCE);
}

// Update JSON editor from Styx source
function updateJsonFromStyx(source) {
    const diagnosticsEl = document.getElementById('diagnostics');

    // Parse and get diagnostics
    const parseResult = parse(source);

    // Convert to JSON
    const jsonResult = to_json(source);

    // Update diagnostics
    if (parseResult.diagnostics && parseResult.diagnostics.length > 0) {
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = parseResult.diagnostics.map(d => {
            const loc = `${d.start}-${d.end}`;
            return `<div class="diagnostic-item"><span class="diagnostic-location">[${loc}]</span>${escapeHtml(d.message)}</div>`;
        }).join('');
    } else {
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = '';
    }

    // Update JSON editor content
    if (jsonResult.success) {
        updatingFromStyx = true;
        jsonEditor.setValue(jsonResult.jsonString);
        updatingFromStyx = false;
    } else {
        updatingFromStyx = true;
        jsonEditor.setValue(`// Error: ${jsonResult.error || 'Unknown error'}`);
        updatingFromStyx = false;
    }
}

// Update Styx editor from JSON source
function updateStyxFromJson(jsonSource) {
    const result = from_json(jsonSource);

    if (result.success) {
        updatingFromJson = true;
        styxEditor.setValue(result.styxString);
        updatingFromJson = false;

        const diagnosticsEl = document.getElementById('diagnostics');
        diagnosticsEl.classList.remove('success');
        diagnosticsEl.innerHTML = '';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

main().catch(err => {
    console.error('Failed to initialize Monaco playground:', err);
    document.getElementById('status').textContent = 'Error';
});
</script>
{% endblock content %}

{# Recursively render a section's pages and subsections #}
{% macro render_section_tree(section, current_path, depth=0) %}
    {% set pages = section.pages | sort(attribute="weight") %}
    {% set subsections = section.subsections | sort(attribute="weight") %}

    {% if pages | length > 0 or subsections | length > 0 %}
    <ul>
        {% for page in pages %}
        <li>
            <a href="{{ page.permalink }}" {% if current_path == page.path %}class="active"{% endif %}>
                {{ page.title or page.path }}
            </a>
        </li>
        {% endfor %}

        {% for subsection_path in subsections %}
            {% set subsection = get_section(path=subsection_path) %}
        <li class="has-children">
            <a href="{{ subsection.permalink }}" {% if current_path is starting_with(subsection.path) %}class="active"{% endif %}>
                {{ subsection.title or subsection.path }}
            </a>
            {{ self::render_section_tree(section=subsection, current_path=current_path, depth=depth+1) }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}
{% endmacro %}

{# Render the sidebar for a given top-level section #}
{% macro sidebar(root_section_path, current_path) %}
    {% set root = get_section(path=root_section_path) %}
    <aside class="sidebar">
        <nav>
            <div class="sidebar-header">
                <a href="{{ root.permalink }}">{{ root.title or root.path }}</a>
            </div>
            {{ self::render_section_tree(section=root, current_path=current_path) }}
        </nav>
    </aside>
{% endmacro %}
